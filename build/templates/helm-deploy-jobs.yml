parameters:
  - name: chartName
    type: string

  - name: vmImage
    type: string
    default: 'ubuntu-latest'

  - name: environment
    type: string
    default: 'aks'

  - name: serviceConnection
    type: string
    default: 'AzureServiceConnection'

  - name: azureResourceGroup
    type: string
    default: 'rg-aks-terraform-d01'

  - name: kubernetesCluster
    type: string
    default: 'my-aks-cluster-d01'

  - name: namespace
    type: string
    default: 'event-triangle'

  - name: helmChartsFolder
    type: string
    default: '$(Pipeline.Workspace)/helm'

jobs:
  - deployment: 'Deploy_Helm_Chart_${{ parameters.appName }}'
    displayName: 'Deploy Helm Chart ${{ parameters.appName }}'
    pool:
      vmImage: ${{ parameters.vmImage }}
    environment: ${{ parameters.environment }}
    strategy:
      runOnce:
        deploy:
          steps:
            - download: current
              artifact: helm

            - task: Kubernetes@1
              displayName: 'Kubernetes Login'
              inputs:
                connectionType: 'Azure Resource Manager'
                azureSubscriptionEndpoint: ${{ parameters.serviceConnection }}
                azureResourceGroup: ${{ parameters.azureResourceGroup }}
                kubernetesCluster: ${{ parameters.kubernetesCluster }}
                namespace: ${{ parameters.namespace }}
                command: 'login'

            - task: HelmInstaller@1
              displayName: 'Install Helm'
              inputs:
                helmVersion: 'latest'

            - script: |
                echo "Deploying Helm chart..."
                helm upgrade --install ${{ parameters.chartName }} ${{ parameters.helmChartsFolder }}/${{ parameters.chartName }} \
                  --namespace ${{ parameters.namespace }} \
                  --set image.tag=$(GitVersion.SemVer) \
                  -f ${{ parameters.helmChartsFolder }}/${{ parameters.chartName }}/values.yml
              displayName: 'Deploy Helm Chart ${{ parameters.chartName }}'
