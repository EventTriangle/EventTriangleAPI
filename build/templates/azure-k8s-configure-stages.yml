parameters:
  - name: vmImage
    type: string

  - name: environment
    type: string

  - name: serviceConnection
    type: string

  - name: azureResourceGroup
    type: string

  - name: kubernetesCluster
    type: string

  - name: namespace
    type: string
    default: 'event-triangle'

  - name: workingDirectory
    displayName: 'Working directory for Kubernetes'
    type: string
    
  - name: transformTargetFiles
    displayName: 'Target files for token replacement'
    type: string
    
  - name: rabbitMqUser
    displayName: 'RabbitMQ User'
    type: string
    
  - name: rabbitMqPassword
    displayName: 'RabbitMQ Password'
    type: string

  - name: dependsOn
    displayName: 'Depends On'
    type: object

  - name: condition
    displayName: 'Condition'
    type: string

stages:
  - stage: 'Configure_AKS_${{ parameters.environment }}'
    displayName: 'Configure_AKS_${{ parameters.environment }}'
    dependsOn: ${{ parameters.dependsOn }}
    condition: succeeded('${{ parameters.condition }}')
    jobs:
      - deployment: 'Configure_AKS_${{ parameters.environment }}'
        displayName: 'Configure_AKS_${{ parameters.environment }}'
        pool:
          vmImage: ${{ parameters.vmImage }}
        environment: ${{ parameters.environment }}
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                  fetchDepth: 0

                - task: Kubernetes@1
                  displayName: 'Kubernetes Login'
                  inputs:
                    connectionType: 'Azure Resource Manager'
                    azureSubscriptionEndpoint: ${{ parameters.serviceConnection }}
                    azureResourceGroup: ${{ parameters.azureResourceGroup }}
                    kubernetesCluster: ${{ parameters.kubernetesCluster }}
                    command: 'login'

                - task: replacetokens@5
                  displayName: 'Replace tokens in secrets'
                  inputs:
                    rootDirectory: ${{ parameters.workingDirectory }}
                    targetFiles: ${{ parameters.transformTargetFiles }}
                    tokenPattern: 'doublebraces'
                    writeBOM: false

                - bash: |
                    kubectl apply -f ./namespace
                  workingDirectory: '${{ parameters.workingDirectory }}'
                  displayName: 'Create namespace'

                - bash: |
                    kubectl apply -f ./secrets --namespace ${{ parameters.namespace }}
                  workingDirectory: '${{ parameters.workingDirectory }}'
                  displayName: 'Deploy secrets'
                  
                - bash: |
                    kubectl apply -f ./pgsql-deployment-load-balancer --namespace ${{ parameters.namespace }}
                  workingDirectory: '${{ parameters.workingDirectory }}'
                  displayName: 'Deploy Postgres'
                  
                - task: PowerShell@2
                  inputs:
                    targetType: 'filePath'
                    filePath: ${{ parameters.workingDirectory }}/helm-install-rabbit-mq/deploy-rabbitmq-helm.ps1
                    arguments: '-HelmReleaseName event-rabbitmq 
                                -Namespace ${{ parameters.namespace }} 
                                -RabbitMqUsername ${{ parameters.rabbitMqUser }} 
                                -RabbitMqPassword ${{ parameters.rabbitMqPassword }}'
                    pwsh: true
                    workingDirectory: ${{ parameters.workingDirectory }}
                  
                - bash: |
                    RABBIT_MQ_IP=$(kubectl get service event-rabbitmq -n ${{ parameters.namespace }} -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
                    echo "RabbitMQ IP: $RABBIT_MQ_IP"
                    POSTGRES_IP=$(kubectl get service postgres-service -n event-triangle -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
                    echo "Postgres IP: $POSTGRES_IP"
                  workingDirectory: '${{ parameters.workingDirectory }}'
                  displayName: 'Update Cloudflare DNS'