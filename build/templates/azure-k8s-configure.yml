parameters:
  - name: vmImage
    type: string

  - name: environment
    type: string

  - name: serviceConnection
    type: string

  - name: azureResourceGroup
    type: string

  - name: kubernetesCluster
    type: string
    
  - name: namespace
    type: string
    default: 'event-triangle'
    
  - name: dependsOn
    displayName: 'Depends On'
    type: object

  - name: condition
    displayName: 'Condition'
    type: string

jobs:
  - deployment: 'Configure_AKS'
    displayName: 'Configure_AKS'
    pool:
      vmImage: ${{ parameters.vmImage }}
    environment: ${{ parameters.environment }}
    strategy:
      runOnce:
        deploy:
          steps:
            - task: Kubernetes@1
              displayName: 'Kubernetes Login'
              inputs:
                connectionType: 'Azure Resource Manager'
                azureSubscriptionEndpoint: ${{ parameters.serviceConnection }}
                azureResourceGroup: ${{ parameters.azureResourceGroup }}
                kubernetesCluster: ${{ parameters.kubernetesCluster }}
                command: 'login'

            - task: replacetokens@5
              displayName: 'Replace tokens in secrets'
              inputs:
                rootDirectory: '${{ parameters.workingDirectory }}'
                targetFiles: |
                  secrets.yaml
                tokenPattern: 'doublebraces'
                writeBOM: false
                
            - bash: |
                kubectl apply -f secrets.yaml --namespace ${{ parameters.namespace }}
              displayName: 'Deploy secrets'